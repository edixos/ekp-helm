rule_files:
  - ../../resources/prometheus-rules/keto.yaml

evaluation_interval: 1m

tests:
  - name: "Keto instance down"
    interval: 1m
    input_series:
      - series: 'up{job="keto-metrics", instance="10.0.32.27:4468"}'
        values: "1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"

    alert_rule_test:
      - eval_time: 15m
        alertname: KetoDown
        exp_alerts:
          - exp_labels:
              severity: critical
              job: "keto-metrics"
              instance: "10.0.32.27:4468"
            exp_annotations:
              summary: "Keto instance is down"
              description: "Keto metrics endpoint has been unreachable for >2 minutes. Instance: 10.0.32.27:4468, Job: keto-metrics"

  - name: "Keto health check failing"
    interval: 1m
    input_series:
      - series: 'http_requests_total{job="keto-metrics", endpoint="/health/ready", code="503"}'
        values: "0 0 2 5 10 16 23 31 40 50 60 70 80 90 100"
      - series: 'http_requests_total{job="keto-metrics", endpoint="/health/ready", code="200"}'
        values: "0 100 200 300 400 500 600 700 800 900 1000 1100 1200 1300 1400"

    alert_rule_test:
      - eval_time: 12m
        alertname: KetoHealthCheckFailing
        exp_alerts:
          - exp_labels:
              severity: critical
              job: "keto-metrics"
              endpoint: "/health/ready"
            exp_annotations:
              summary: "Keto health check failing"
              description: "Keto /health/alive or /health/ready returning non-200 for >3m. Job: keto-metrics, Endpoint: /health/ready"

  - name: "Keto high GC pauses"
    interval: 1m
    input_series:
      - series: 'go_gc_duration_seconds{job="keto-metrics", instance="10.0.32.27:4468", quantile="0.95"}'
        values: "0.1 0.12 0.15 0.2 0.3 0.4 0.55 0.62 0.68 0.71 0.74 0.78 0.82 0.85 0.88 0.90"

    alert_rule_test:
      - eval_time: 15m
        alertname: KetoHighGCPauses
        exp_alerts:
          - exp_labels:
              severity: warning
              job: "keto-metrics"
              instance: "10.0.32.27:4468"
              quantile: "0.95"
            exp_annotations:
              summary: "Keto high GC pauses (p95 >500ms)"
              description: "GC pauses are too long (p95 = 0.9s). May cause increased latency or timeouts. Instance: 10.0.32.27:4468"
